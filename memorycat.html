<!-- ESTE ES EL JUEGO COMPLETO CON LA TABLA DE SEGUIMIENTO Y LA PUNTUACI√ìN. -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoryCat</title>

    <!-- 
    OBJETIVO: Aplicaci√≥n de seguimiento de aciertos con edici√≥n local, persistencia local y exportaci√≥n/importaci√≥n de datos via JSON.
    - Exportaci√≥n: Genera 3 archivos JSON (jugadores, preguntas, aciertos).
    - Importaci√≥n: Lee 3 archivos JSON subidos por el usuario para restaurar el estado.
    -->

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Usamos la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* gray-100 */
        }
        /* Estilos personalizados para los checkboxes */
        .form-checkbox {
            height: 1.5rem;
            width: 1.5rem;
            min-width: 1.5rem; 
            min-height: 1.5rem; 
            cursor: pointer;
            border-radius: 0.25rem;
            border-color: #a0aec0; /* gray-400 */
        }
        .form-checkbox:checked {
             border-color: transparent;
             background-color: #38a169; /* green-600 */
             /* Usamos SVG para el checkmark en lugar de la imagen de fondo por defecto */
             background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M13.67 4.33a.85.85 0 011.2 0l-7.25 7.25a.85.85 0 01-1.2 0L.33 8.33a.85.85 0 011.2-1.2l3.75 3.75 6.67-6.67a.85.85 0 011.2 0z'/%3e%3c/svg%3e");
             background-size: 100% 100%;
             background-position: center;
             background-repeat: no-repeat;
        }
        /* Estilo para el hover de las celdas de pregunta */
        th[data-question-id]:hover,
        .player-button:hover {
            cursor: pointer;
            background-color: #e2e8f0; /* gray-200 */
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-indigo-800">MemoryCat</h1>
            <p class="text-xl text-gray-600 mt-1">Seguimiento de aciertos de preguntas</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-4 md:p-6">
            
            <!-- Controles de Importaci√≥n / Exportaci√≥n -->
            <div class="flex flex-col sm:flex-row justify-between gap-3 mb-6 p-4 bg-gray-50 rounded-lg border">
                
                <button id="export-data" class="flex-1 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150">
                    Exportar Datos (JSON) 
                </button>
                
                <!-- Input de archivo oculto para la importaci√≥n -->
                <input type="file" id="import-file-input" accept=".json" multiple hidden>
                <button id="import-data" class="flex-1 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150">
                    Importar Datos (JSON) 
                </button>
            </div>


            <div id="loading-spinner" class="hidden text-center p-4">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full" role="status"></div>
                <p class="text-indigo-600 mt-2">Cargando datos...</p>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead id="table-head" class="bg-indigo-50 border-b-2 border-indigo-200">
                        <tr>
                            <th scope="col" class="sticky left-0 bg-indigo-50 px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">
                                Jugador
                            </th>
                            <!-- Las cabeceras de Preguntas se generan con JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas de jugadores se generan con JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 text-sm text-gray-500 p-2 border-t pt-4">
                <p>üí° Haz clic en el nombre de un jugador para **editar sus datos o ver su puntuaci√≥n**. Haz clic en la cabecera de una pregunta para editar su contenido.</p>
                <div id="feedback-message" class="mt-2 text-center font-semibold text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Jugador y Puntuaci√≥n -->
    <div id="player-edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 transition-opacity duration-300" style="backdrop-filter: blur(5px);">
        <!-- Contenido del Modal -->
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white transform transition-all duration-300">
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-bold text-indigo-800 mb-4" id="modal-player-edit-title">Editar Jugador</h3>
                
                <form id="player-edit-form" class="space-y-4">
                    <!-- Campo oculto para guardar el ID del jugador que se est√° editando -->
                    <input type="hidden" id="modal-p-id"> 

                    <!-- Puntuaci√≥n Actual (Solo lectura) -->
                    <div class="bg-indigo-50 p-3 rounded-lg">
                        <p class="text-lg text-gray-700">Puntuaci√≥n: <span class="font-extrabold text-green-600" id="modal-player-score">0</span> Puntos</p>
                    </div>

                    <!-- Campos de Edici√≥n -->
                    <div class="text-left">
                        <label for="modal-p-input-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="modal-p-input-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    
                    <div class="text-left">
                        <label for="modal-p-input-lastname" class="block text-sm font-medium text-gray-700">Apellidos</label>
                        <input type="text" id="modal-p-input-lastname" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <p class="text-sm text-gray-500 pt-2 border-t" id="modal-player-hits-details"></p>

                    <div class="flex space-x-4 mt-6">
                        <button type="button" id="modal-p-close" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-lg w-1/2 shadow-md hover:bg-gray-400 transition duration-150">
                            Cerrar
                        </button>
                        <button type="submit" id="modal-p-save" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg w-1/2 shadow-md hover:bg-indigo-700 transition duration-150">
                            Guardar Datos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal de Detalles/Edici√≥n de la Pregunta -->
    <div id="question-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 transition-opacity duration-300" style="backdrop-filter: blur(5px);">
        <!-- Contenido del Modal -->
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white transform transition-all duration-300">
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-bold text-indigo-800 mb-4" id="modal-q-title">Editar Pregunta</h3>
                <form id="question-edit-form" class="space-y-4">
                    <!-- Campo oculto para guardar el ID de la pregunta que se est√° editando -->
                    <input type="hidden" id="modal-q-id"> 

                    <!-- Campo T√≠tulo -->
                    <div class="text-left">
                        <label for="modal-q-input-title" class="block text-sm font-medium text-gray-700">T√≠tulo Corto (Ej: Pregunta A)</label>
                        <input type="text" id="modal-q-input-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- Campo Enunciado -->
                    <div class="text-left">
                        <label for="modal-q-input-enunciado" class="block text-sm font-medium text-gray-700">Enunciado de la Pregunta</label>
                        <textarea id="modal-q-input-enunciado" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- Campo Respuesta Clave -->
                    <div class="text-left">
                        <label for="modal-q-input-respuesta" class="block text-sm font-medium text-gray-700">Respuesta Clave (para calcular puntos)</label>
                        <textarea id="modal-q-input-respuesta" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                        <!-- MENSAJE DE PUNTUACI√ìN ACTUALIZADO -->
                        <p class="text-xs text-gray-500 mt-1">Puntuaci√≥n actual: <span id="modal-q-calculated-points" class="font-bold">0</span> puntos (igual al n√∫mero de palabras en la respuesta).</p>
                    </div>

                    <div class="flex space-space-x-4 mt-6">
                        <button type="button" id="modal-q-close" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-lg w-1/2 shadow-md hover:bg-gray-400 transition duration-150">
                            Cancelar
                        </button>
                        <button type="submit" id="modal-q-save" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-lg w-1/2 shadow-md hover:bg-green-700 transition duration-150">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // *** 1. ESTRUCTURA DE DATOS INICIAL (La "Importaci√≥n por JSON") ***
        const initialQuestionsData = [
            { id: 'q1', title: 'Pregunta A', enunciado: '¬øCu√°l es la capital de Espa√±a?', respuesta: 'Madrid' },
            { id: 'q2', title: 'Pregunta B', enunciado: '¬øQui√©n escribi√≥ El Quijote?', respuesta: 'Miguel de Cervantes' },
            { id: 'q3', title: 'Pregunta C', enunciado: 'Elemento qu√≠mico cuyo s√≠mbolo es H', respuesta: 'Hidr√≥geno' },
            { id: 'q4', title: 'Pregunta D', enunciado: 'N√∫mero de d√≠as en un a√±o bisiesto', respuesta: '366 d√≠as' },
            { id: 'q5', title: 'Pregunta E', enunciado: 'El planeta rojo', respuesta: 'Marte' },
            { id: 'q6', title: 'Pregunta F', enunciado: 'Ave que no vuela', respuesta: 'Ping√ºino' },
            { id: 'q7', title: 'Pregunta G', enunciado: '¬øQu√© es un byte?', respuesta: 'Un conjunto de 8 bits' },
            { id: 'q8', title: 'Pregunta H', enunciado: 'Cuerpo geom√©trico con 6 caras cuadradas', respuesta: 'Cubo' },
            { id: 'q9', title: 'Pregunta I', enunciado: 'La moneda oficial de Jap√≥n', respuesta: 'Yen' },
            { id: 'q10', title: 'Pregunta J', enunciado: 'El r√≠o m√°s largo del mundo', respuesta: 'Amazonas' },
        ];

        const initialPlayers = {
            'player1': { id: 'player1', name: 'Alba', lastName: 'Garc√≠a' },
            'player2': { id: 'player2', name: 'Benito', lastName: 'L√≥pez' },
            'player3': { id: 'player3', name: 'Carla', lastName: 'Mart√≠nez' },
            'player4': { id: 'player4', name: 'David', lastName: 'Rodr√≠guez' },
        };

        // Funci√≥n auxiliar para calcular puntos: SOLO el n√∫mero de palabras (sin +2)
        const countWords = (text) => {
            if (!text || typeof text !== 'string') return 0;
            // Usa una expresi√≥n regular para dividir por espacios y filtra cadenas vac√≠as
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        const calculatePoints = (respuesta) => countWords(respuesta);
        
        // Estructura de datos principal de Preguntas
        let questions = initialQuestionsData.map(q => ({
            ...q,
            puntos: calculatePoints(q.respuesta) 
        }));
        
        // Estructura de datos principal de Jugadores
        let players = initialPlayers;
        
        // Estado de aciertos: {'playerId-questionId': true/false}
        let hitsState = {}; 


        // *** 2. PERSISTENCIA LOCAL (LocalStorage) ***
        const localStorageKeyQuestions = 'memorycatQuestions';
        const localStorageKeyPlayers = 'memorycatPlayers';
        const localStorageKeyHits = 'memorycatHitsState';

        /** Carga el estado de aciertos, preguntas y jugadores desde localStorage o inicializa. */
        const loadState = () => {
            // Cargar Preguntas
            const savedQuestions = localStorage.getItem(localStorageKeyQuestions);
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
                // Asegurar que la puntuaci√≥n se recalcule por si la regla ha cambiado
                questions = questions.map(q => ({
                    ...q,
                    puntos: calculatePoints(q.respuesta)
                }));
            }
            
            // Cargar Jugadores
            const savedPlayers = localStorage.getItem(localStorageKeyPlayers);
            players = savedPlayers ? JSON.parse(savedPlayers) : initialPlayers;

            // Cargar Aciertos
            const savedHits = localStorage.getItem(localStorageKeyHits);
            hitsState = savedHits ? JSON.parse(savedHits) : {};
        };

        /** Guarda el estado actual de aciertos, preguntas y jugadores en localStorage. */
        const saveState = () => {
            localStorage.setItem(localStorageKeyQuestions, JSON.stringify(questions));
            localStorage.setItem(localStorageKeyPlayers, JSON.stringify(players));
            localStorage.setItem(localStorageKeyHits, JSON.stringify(hitsState));
        };


        // *** 3. FUNCIONES DE RENDERING Y L√ìGICA DE EDICI√ìN ***
        
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const feedbackMessage = document.getElementById('feedback-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Elementos del modal de Pregunta
        const modalQInputTitle = document.getElementById('modal-q-input-title');
        const modalQInputEnunciado = document.getElementById('modal-q-input-enunciado');
        const modalQInputRespuesta = document.getElementById('modal-q-input-respuesta');
        const modalQCalculatedPoints = document.getElementById('modal-q-calculated-points');
        
        // Elementos del modal de Jugador 
        const modalPInputName = document.getElementById('modal-p-input-name');
        const modalPInputLastName = document.getElementById('modal-p-input-lastname');
        const modalPlayerEditTitle = document.getElementById('modal-player-edit-title');


        /** Muestra un mensaje de feedback y lo oculta despu√©s de 3 segundos. */
        const showFeedback = (message, isError = false) => {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `mt-2 text-center font-semibold text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
            clearTimeout(feedbackMessage.timeout);
            feedbackMessage.timeout = setTimeout(() => {
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'mt-2 text-center font-semibold text-sm';
            }, 3000);
        };

        const showLoading = (show) => {
            loadingSpinner.classList.toggle('hidden', !show);
        };


        /** Renderiza la cabecera de la tabla con las preguntas. */
        const renderTableHead = () => {
            const headerRow = tableHead.querySelector('tr');
            // Mantener solo la primera celda (Jugador)
            headerRow.innerHTML = '<th scope="col" class="sticky left-0 bg-indigo-50 px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Jugador</th>'; 

            questions.forEach((q) => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.dataset.questionId = q.id; 
                th.className = 'px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider transition duration-150 rounded-t-md';
                
                th.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="font-bold text-sm">${q.title}</span>
                        <span class="text-xs text-indigo-500">${q.puntos} Pts</span>
                    </div>
                `;
                headerRow.appendChild(th);
            });
        };

        /** Renderiza el cuerpo de la tabla con jugadores y checkboxes. */
        const renderTableBody = () => {
            tableBody.innerHTML = ''; // Limpiar contenido existente

            // Usamos Object.values(players) para asegurar el orden
            Object.values(players).forEach((player, playerIndex) => {
                const tr = document.createElement('tr');
                tr.className = playerIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Celda del Jugador (Bot√≥n para abrir Modal de Edici√≥n/Puntuaci√≥n)
                const fullName = `${player.name} ${player.lastName || ''}`.trim();

                const playerCell = document.createElement('td');
                playerCell.className = 'sticky left-0 bg-inherit px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200';
                playerCell.innerHTML = `
                    <button class="player-button text-indigo-600 hover:text-indigo-900 font-bold p-1 rounded-md transition duration-150" data-player-id="${player.id}">
                        ${fullName}
                    </button>
                `;
                tr.appendChild(playerCell);

                // Celdas de Checkboxes (Aciertos)
                questions.forEach(q => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-2 whitespace-nowrap text-center';
                    const hitId = `${player.id}-${q.id}`;
                    const isChecked = hitsState[hitId] || false; // Estado del checkbox

                    cell.innerHTML = `
                        <input type="checkbox" id="${hitId}" 
                               class="form-checkbox text-green-600 border-gray-300 focus:ring-green-500" 
                               ${isChecked ? 'checked' : ''}>
                    `;
                    tr.appendChild(cell);
                });

                tableBody.appendChild(tr);
            });
        };
        
        /** Renderizado completo de la interfaz */
        const fullRender = () => {
             renderTableHead();
             renderTableBody();
             saveState(); // Guardar el nuevo estado en localStorage despu√©s de cada renderizado completo
        }

        // *** 4. L√ìGICA DE IMPORTACI√ìN Y EXPORTACI√ìN ***

        /**
         * Descarga un objeto JSON como archivo en el navegador.
         * @param {object} data El objeto de datos a exportar.
         * @param {string} filename Nombre del archivo.
         */
        const downloadJson = (data, filename) => {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        /** Manejador de la exportaci√≥n: crea y descarga los tres archivos. */
        const handleExport = () => {
            // 1. Exportar Jugadores
            downloadJson(players, 'memcat_jugadores.json');
            
            // 2. Exportar Preguntas
            // Creamos una copia para evitar exportar las funciones/propiedades que no son parte del modelo
            const exportQuestions = questions.map(q => ({
                id: q.id,
                title: q.title,
                enunciado: q.enunciado,
                respuesta: q.respuesta,
                puntos: q.puntos // Esto es calculado, pero lo incluimos para claridad
            }));
            downloadJson(exportQuestions, 'memcat_preguntas.json');

            // 3. Exportar Aciertos
            downloadJson(hitsState, 'memcat_aciertos.json');

            showFeedback('¬°Datos exportados correctamente! Se han descargado 3 archivos JSON.');
        };
        
        /**
         * Manejador de la importaci√≥n: lee los archivos subidos y actualiza el estado.
         */
        const handleImport = (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showLoading(true);
            let importedData = {
                jugadores: null,
                preguntas: null,
                aciertos: null
            };
            let filesRead = 0;

            const updateStateAndRender = () => {
                // Verificar si todos los archivos han sido le√≠dos (o al menos se ha intentado)
                if (filesRead === files.length) {
                    
                    // 1. Actualizar Jugadores
                    if (importedData.jugadores) {
                        players = importedData.jugadores;
                        console.log('Jugadores importados:', Object.keys(players).length);
                    } else {
                        console.warn('Archivo de jugadores no encontrado o inv√°lido. Manteniendo datos actuales.');
                    }

                    // 2. Actualizar Preguntas
                    if (importedData.preguntas && Array.isArray(importedData.preguntas) && importedData.preguntas.length > 0) {
                        questions = importedData.preguntas.map(q => ({
                            ...q,
                            // Recalcular puntos con la regla actual para asegurar consistencia
                            puntos: calculatePoints(q.respuesta || '') 
                        }));
                        console.log('Preguntas importadas:', questions.length);
                    } else {
                        console.warn('Archivo de preguntas no encontrado o inv√°lido. Manteniendo datos actuales.');
                    }

                    // 3. Actualizar Aciertos
                    if (importedData.aciertos) {
                        hitsState = importedData.aciertos;
                        console.log('Aciertos importados:', Object.keys(hitsState).length);
                    } else {
                        console.warn('Archivo de aciertos no encontrado o inv√°lido. Manteniendo datos actuales.');
                    }
                    
                    // 4. Forzar el renderizado y guardar en localStorage
                    fullRender();
                    showLoading(false);
                    showFeedback('¬°Importaci√≥n de datos completada!', false);
                }
            };
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        const fileName = file.name.toLowerCase();

                        if (fileName.includes('jugadores')) {
                            importedData.jugadores = json;
                        } else if (fileName.includes('preguntas')) {
                            importedData.preguntas = json;
                        } else if (fileName.includes('aciertos')) {
                            importedData.aciertos = json;
                        }
                    } catch (error) {
                        console.error('Error al parsear el archivo JSON:', file.name, error);
                        showFeedback(`Error al leer el archivo ${file.name}. Aseg√∫rate de que es un JSON v√°lido.`, true);
                    } finally {
                        filesRead++;
                        updateStateAndRender();
                    }
                };
                reader.onerror = () => {
                    filesRead++;
                    console.error('Error al leer el archivo:', file.name);
                    updateStateAndRender();
                };
                reader.readAsText(file);
            });
        };
        

        // *** 5. L√ìGICA MODALES (Sin cambios) ***

        const playerEditModal = document.getElementById('player-edit-modal'); 
        const questionModal = document.getElementById('question-modal');

        const showModal = (modalElement) => {
            modalElement.classList.remove('hidden');
        };

        const hideModal = (modalElement) => {
            modalElement.classList.add('hidden');
        };

        /** Muestra el modal con la puntuaci√≥n y campos editables del jugador. */
        const showPlayerEditModal = (playerId) => {
            const player = players[playerId];
            if (!player) return;

            // 1. Calcular Puntuaci√≥n y Detalles
            let score = 0;
            let hitsDetails = [];

            questions.forEach(q => {
                const hitId = `${playerId}-${q.id}`;
                if (hitsState[hitId]) {
                    score += q.puntos;
                    hitsDetails.push(`‚úÖ ${q.title} (${q.puntos} Pts)`);
                }
            });

            // 2. Llenar el contenido del modal
            modalPlayerEditTitle.textContent = `Editar Jugador: ${player.name} ${player.lastName}`;
            document.getElementById('modal-p-id').value = player.id; 
            
            // Campos de edici√≥n
            modalPInputName.value = player.name;
            modalPInputLastName.value = player.lastName || '';
            
            // Puntuaci√≥n y detalles
            document.getElementById('modal-player-score').textContent = score;
            document.getElementById('modal-player-hits-details').innerHTML = 
                `**Aciertos:** ${hitsDetails.length > 0 ? hitsDetails.join(', ') : 'Ninguno.'}`;

            showModal(playerEditModal);
        }
        
        /** Manejador de la edici√≥n local del jugador */
        const handlePlayerEditSubmit = (event) => {
            event.preventDefault();

            const playerId = document.getElementById('modal-p-id').value;
            const updatedName = modalPInputName.value.trim();
            const updatedLastName = modalPInputLastName.value.trim();

            if (players[playerId]) {
                // 1. Actualizar el objeto en la estructura players
                players[playerId].name = updatedName;
                players[playerId].lastName = updatedLastName;

                // 2. Re-renderizar la tabla para reflejar los cambios
                fullRender();
                
                // 3. Ocultar el modal
                hideModal(playerEditModal);
                
                showFeedback('Datos del jugador guardados.');
            } else {
                console.error('No se pudo encontrar el jugador para actualizar.');
            }
        }


        /** Muestra el modal de edici√≥n de la Pregunta. */
        const showQuestionModal = (questionId) => {
            const q = questions.find(q => q.id === questionId);
            if (!q) return;

            // 1. Cargar datos en el formulario
            document.getElementById('modal-q-id').value = q.id;
            document.getElementById('modal-q-title').textContent = `Editar: ${q.title}`;
            modalQInputTitle.value = q.title;
            modalQInputEnunciado.value = q.enunciado;
            modalQInputRespuesta.value = q.respuesta;
            modalQCalculatedPoints.textContent = q.puntos; 

            // 2. Listener para actualizar puntos en tiempo real (feedback)
            const updatePoints = () => {
                const newResponse = modalQInputRespuesta.value;
                modalQCalculatedPoints.textContent = calculatePoints(newResponse); 
            };
            modalQInputRespuesta.removeEventListener('input', updatePoints); 
            modalQInputRespuesta.addEventListener('input', updatePoints); 

            showModal(questionModal);
        }
        
        /** Manejador de la edici√≥n local de la pregunta */
        const handleQuestionEditSubmit = (event) => {
            event.preventDefault();

            const questionId = document.getElementById('modal-q-id').value;
            const updatedTitle = modalQInputTitle.value.trim();
            const updatedEnunciado = modalQInputEnunciado.value.trim();
            const updatedRespuesta = modalQInputRespuesta.value.trim();

            // Buscar el √≠ndice de la pregunta
            const questionIndex = questions.findIndex(q => q.id === questionId);

            if (questionIndex !== -1) {
                // 1. Actualizar el objeto
                questions[questionIndex].title = updatedTitle;
                questions[questionIndex].enunciado = updatedEnunciado;
                questions[questionIndex].respuesta = updatedRespuesta;
                questions[questionIndex].puntos = calculatePoints(updatedRespuesta);

                // 2. Re-renderizar la tabla 
                fullRender();
                
                // 3. Ocultar el modal
                hideModal(questionModal);
                
                showFeedback('Datos de la pregunta guardados.');
            } else {
                console.error('No se pudo encontrar la pregunta para actualizar.');
            }
        }


        // *** 6. INICIALIZACI√ìN Y LISTENERS PRINCIPALES ***

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Cargar el estado guardado y realizar el renderizado inicial
            loadState();
            fullRender();


            // --- LISTENERS DE INTERFAZ Y L√ìGICA ---

            // 1. Escucha cambios en checkboxes para guardar estado (delegaci√≥n de eventos)
            tableBody.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    const checkbox = event.target;
                    hitsState[checkbox.id] = checkbox.checked; 
                    saveState(); 
                    
                    // Si el modal de jugador est√° abierto, actualiza su puntuaci√≥n
                    const [playerId] = checkbox.id.split('-');
                    if (!playerEditModal.classList.contains('hidden')) {
                        showPlayerEditModal(playerId); 
                    }
                }
            });

            // 2. Escucha clics en botones de jugador para abrir el modal de EDICI√ìN/PUNTUACI√ìN
            tableBody.addEventListener('click', (event) => {
                const button = event.target.closest('.player-button');
                if (button) showPlayerEditModal(button.dataset.playerId);
            });

            // 3. Escucha clics en la cabecera para abrir el modal de EDICI√ìN de Pregunta
            tableHead.addEventListener('click', (event) => {
                const header = event.target.closest('th[data-question-id]');
                if (header) showQuestionModal(header.dataset.questionId);
            });
            
            // 4. Listener para la EXPORTACI√ìN
            document.getElementById('export-data').addEventListener('click', handleExport);

            // 5. Listener para la IMPORTACI√ìN (el bot√≥n simula un click en el input)
            document.getElementById('import-data').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            
            // 6. Listener para el cambio real del archivo de IMPORTACI√ìN
            document.getElementById('import-file-input').addEventListener('change', handleImport);

            // 7. Listeners de formularios de Edici√≥n
            document.getElementById('player-edit-form').addEventListener('submit', handlePlayerEditSubmit);
            document.getElementById('question-edit-form').addEventListener('submit', handleQuestionEditSubmit);

            // 8. Listeners para cerrar modales
            document.getElementById('modal-p-close').addEventListener('click', () => hideModal(playerEditModal));
            document.getElementById('modal-q-close').addEventListener('click', (e) => {
                e.preventDefault(); 
                hideModal(questionModal);
            });

            // 9. Cerrar al hacer clic en el fondo
            playerEditModal.addEventListener('click', (e) => {
                 if (e.target === playerEditModal) hideModal(playerEditModal);
            });
            questionModal.addEventListener('click', (e) => {
                 if (e.target === questionModal) hideModal(questionModal);
            });
        });

    </script>
</body>
</html>
